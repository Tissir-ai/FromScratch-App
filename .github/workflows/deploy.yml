name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          frontend/node_modules
          auth/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json', 'auth/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm install
    
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
    
    - name: Install auth dependencies
      working-directory: ./auth
      run: npm install
    
    - name: Generate Prisma client
      working-directory: ./auth
      run: npx prisma generate
      env:
        DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
    
    - name: Build auth service
      working-directory: ./auth
      run: npm run build
    
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
      env:
        NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GITHUB_CLIENT_ID: ${{ secrets.GITHUB_CLIENT_ID }}
        GITHUB_CLIENT_SECRET: ${{ secrets.GITHUB_CLIENT_SECRET }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        envs: NVIDIA_API_KEY,STRIPE_SECRET_KEY,STRIPE_WEBHOOK_SECRET,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,GITHUB_CLIENT_ID,GITHUB_CLIENT_SECRET,GMAIL_USER,GMAIL_APP_PASSWORD
        script: |
          cd /srv/teams/TissirAi/FromScratch-App || exit 1
          
          # Pull latest code
          git pull origin main
          
          # Create .env file with secrets from GitHub Actions
          cat > .env << EOF
          NVIDIA_API_KEY=$NVIDIA_API_KEY
          STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY
          STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET
          GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
          GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
          GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID
          GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET
          GMAIL_USER=$GMAIL_USER
          GMAIL_APP_PASSWORD=$GMAIL_APP_PASSWORD
          EOF
          
          # Verify .env was created
          echo "✓ .env file created"
          ls -la .env
          
          # Set restrictive permissions (only owner can read/write)
          chmod 600 .env
          echo "✓ .env permissions set to 600"
          
          # Stop containers
          docker compose down
          
          # Build and start containers with environment variables
          docker compose build --no-cache
          docker compose up -d --force-recreate
          
          # Show deployment status
          echo "✓ Deployment completed!"
          docker compose ps
          echo "Deployment completed!"
          docker compose ps
          
          # Clean up old images
          docker system prune -af --volumes
